import sys
import numpy as np
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QLineEdit, QToolBar, QAction, QMessageBox
)
from PyQt5.QtWebEngineWidgets import QWebEngineView
from PyQt5.QtCore import QUrl


class QuantumPageState:
    def __init__(self, states):
        total_prob = sum(abs(a)**2 for a in states.values())
        if not np.isclose(total_prob, 1):
            raise ValueError("ì§„í­ ì œê³±í•©ì´ 1ì´ì–´ì•¼ í•©ë‹ˆë‹¤.")
        self.states = states

    def measure(self):
        keys = list(self.states.keys())
        probs = [abs(a)**2 for a in self.states.values()]
        chosen_state = np.random.choice(keys, p=probs)
        self.states = {k: (1+0j if k == chosen_state else 0+0j) for k in keys}
        return chosen_state

    def __str__(self):
        return " | ".join(f"{k}: {a:.4f}" for k, a in self.states.items())


class QuantumBrowser(QMainWindow):
    def __init__(self, home_url="https://www.google.com"):
        super().__init__()
        self.setWindowTitle("Quantum Web Browser")
        self.setGeometry(100, 100, 1200, 800)

        self.home_url = home_url

        # íˆ´ë°”
        navtb = QToolBar()
        self.addToolBar(navtb)

        # URL ì…ë ¥ì°½
        self.urlbar = QLineEdit()
        self.urlbar.returnPressed.connect(self.navigate_to_url)
        navtb.addWidget(self.urlbar)

        # ë²„íŠ¼ë“¤
        back_btn = QAction("â†", self)
        back_btn.triggered.connect(self.go_back)
        navtb.addAction(back_btn)

        forward_btn = QAction("â†’", self)
        forward_btn.triggered.connect(self.go_forward)
        navtb.addAction(forward_btn)

        reload_btn = QAction("âŸ³", self)
        reload_btn.triggered.connect(self.reload_page)
        navtb.addAction(reload_btn)

        home_btn = QAction("ğŸ ", self)
        home_btn.triggered.connect(self.go_home)
        navtb.addAction(home_btn)

        newwin_btn = QAction("ìƒˆì°½", self)
        newwin_btn.triggered.connect(self.open_new_window)
        navtb.addAction(newwin_btn)

        exit_btn = QAction("ì¢…ë£Œ", self)
        exit_btn.triggered.connect(self.close)
        navtb.addAction(exit_btn)

        # ì›¹ ì—”ì§„ë·°
        self.browser = QWebEngineView()
        self.setCentralWidget(self.browser)
        self.browser.urlChanged.connect(self.update_urlbar)
        self.browser.loadFinished.connect(self.on_load_finished)

        # ì´ˆê¸° ë¡œë“œ
        self.browser.load(QUrl(self.home_url))

        # ì´ˆê¸° ì–‘ì ìƒíƒœ
        self.reset_quantum_state()

    def reset_quantum_state(self):
        self.quantum_state = QuantumPageState({
            "loading": 1/np.sqrt(3) + 0j,
            "rendered": 1/np.sqrt(3) + 0j,
            "error": 1/np.sqrt(3) + 0j,
        })

    def navigate_to_url(self):
        url = self.urlbar.text()
        if not url.startswith("http"):
            url = "http://" + url
        self.browser.load(QUrl(url))
        self.quantum_state = QuantumPageState({
            "loading": 1 + 0j,
            "rendered": 0 + 0j,
            "error": 0 + 0j,
        })
        print("\ní˜ì´ì§€ ë¡œë”© ì‹œì‘, ì–‘ì ìƒíƒœ ì´ˆê¸°í™”:")
        print(self.quantum_state)

    def update_urlbar(self, q):
        self.urlbar.setText(q.toString())

    def go_back(self):
        self.browser.back()

    def go_forward(self):
        self.browser.forward()

    def reload_page(self):
        self.browser.reload()

    def go_home(self):
        self.browser.load(QUrl(self.home_url))
        self.reset_quantum_state()
        print("\ní™ˆìœ¼ë¡œ ì´ë™, ì–‘ì ìƒíƒœ ì´ˆê¸°í™”:")
        print(self.quantum_state)

    def open_new_window(self):
        self.new_window = QuantumBrowser(self.home_url)
        self.new_window.show()
        print("\nìƒˆ ì°½ ì—´ë¦¼")

    def on_load_finished(self, ok):
        if ok:
            self.quantum_state = QuantumPageState({
                "loading": 0 + 0j,
                "rendered": 1 + 0j,
                "error": 0 + 0j,
            })
        else:
            self.quantum_state = QuantumPageState({
                "loading": 0 + 0j,
                "rendered": 0 + 0j,
                "error": 1 + 0j,
            })

        collapsed = self.quantum_state.measure()
        print("\ní˜ì´ì§€ ë¡œë”© ì™„ë£Œ, ì¸¡ì • í›„ ìƒíƒœ (collapse):", collapsed)
        print("ì¸¡ì • í›„ ì–‘ì ìƒíƒœ:")
        print(self.quantum_state)

    def closeEvent(self, event):
        reply = QMessageBox.question(
            self, 'ì¢…ë£Œ í™•ì¸',
            "ì •ë§ ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            QMessageBox.Yes | QMessageBox.No, QMessageBox.No
        )
        if reply == QMessageBox.Yes:
            event.accept()
        else:
            event.ignore()


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = QuantumBrowser()
    window.show()
    sys.exit(app.exec_())
